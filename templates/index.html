<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeSteward Results Analyzer</title>
    <script src="https://cdn.plot.ly/plotly-3.0.1.min.js" charset="utf-8"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            position: relative;
        }
        
        .github-link {
            position: absolute;
            top: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .github-link:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #f8f9ff;
            border-color: #764ba2;
        }
        
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-text h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .upload-text p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .results h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-positive {
            color: #4caf50;
        }
        
        .metric-negative {
            color: #f44336;
        }
        
        .charts-section {
            margin-top: 30px;
        }
        
        .chart-container {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .chart-container img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .strategy-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .strategy-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .strategy-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .strategy-table th,
        .strategy-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .strategy-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .strategy-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .info-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #2196f3;
        }
        
        .info-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .info-section ul {
            color: #333;
            margin-left: 20px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f44336;
            margin-top: 20px;
        }

        .nav-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .nav-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 0 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Authentication Styles */
        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-form h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .auth-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .auth-button {
            width: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
        }
        
        .user-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .logout-button:hover {
            background: #c82333;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="https://github.com/perfectm/TradeSteward-Results-Analyzer" target="_blank" class="github-link">
                📂 View on GitHub
            </a>
            <h1>🎯 TradeSteward Results Analyzer</h1>
            <p>Advanced analysis tool for options trading performance</p>
        </div>
        
        <div class="info-section">
            <h4>📊 What This Tool Analyzes:</h4>
            <ul>
                <li><strong>Strategy Performance:</strong> P&L by strategy type (Ratio Condors, etc.)</li>
                <li><strong>Risk Metrics:</strong> Win rate, profit factor, maximum drawdown, Sharpe ratio</li>
                <li><strong>Market Conditions:</strong> VIX correlation and market environment analysis</li>
                <li><strong>Time Analysis:</strong> Daily, monthly performance tracking</li>
                <li><strong>Commission Impact:</strong> Gross vs net P&L analysis</li>
                <li><strong>🔄 Persistent Data:</strong> Upload multiple CSV files - new trades are added, duplicates are skipped</li>
            </ul>
        </div>
        
        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h4 style="color: #495057; margin-bottom: 10px;">🔐 Authentication Required</h4>
                <p style="color: #6c757d; margin: 0;">Please login or register to access your trading analysis dashboard with commission tracking, strategy breakdowns, and comprehensive performance metrics.</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showLogin()">Login</button>
                <button class="auth-tab" onclick="showRegister()">Register</button>
            </div>
            
            <div class="auth-form" id="loginForm">
                <h3>Login to Your Account</h3>
                <form onsubmit="handleLogin(event)">
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="password" name="password" placeholder="Password" required>
                    <button type="submit" class="auth-button">Login</button>
                </form>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showForgotPassword()" style="color: #667eea; text-decoration: none; font-size: 0.9rem;">
                        🔑 Forgot your password?
                    </a>
                </div>
            </div>
            
            <div class="auth-form hidden" id="registerForm">
                <h3>Create New Account</h3>
                <form onsubmit="handleRegister(event)">
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="email" name="email" placeholder="Email" required>
                    <input type="password" name="password" placeholder="Password (min 6 characters)" required minlength="6">
                    <button type="submit" class="auth-button">Register</button>
                </form>
            </div>
            
            <div class="auth-form hidden" id="forgotPasswordForm">
                <h3>Reset Your Password</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                    Enter your username to reset your password
                </p>
                <form onsubmit="handleForgotPassword(event)">
                    <input type="text" name="username" placeholder="Username" required>
                    <button type="submit" class="auth-button">Reset Password</button>
                </form>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showLogin()" style="color: #667eea; text-decoration: none; font-size: 0.9rem;">
                        ← Back to Login
                    </a>
                </div>
            </div>
            
            <div class="auth-form hidden" id="newPasswordForm">
                <h3>Set New Password</h3>
                <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 0.9rem;">
                    Enter your new password
                </p>
                <form onsubmit="handleNewPassword(event)">
                    <input type="hidden" name="username" id="resetUsernameHidden">
                    <input type="password" name="new_password" placeholder="New Password (min 6 characters)" required minlength="6">
                    <input type="password" name="confirm_password" placeholder="Confirm New Password" required minlength="6">
                    <button type="submit" class="auth-button">Update Password</button>
                </form>
                <div style="text-align: center; margin-top: 15px;">
                    <a href="#" onclick="showLogin()" style="color: #667eea; text-decoration: none; font-size: 0.9rem;">
                        ← Back to Login
                    </a>
                </div>
            </div>
        </div>

        <!-- User Info Section -->
        <div class="user-section hidden" id="userSection">
            <div class="user-info">
                <span id="userWelcome">Welcome, <strong id="username"></strong>!</span>
                <div>
                    <button class="reset-password-button" onclick="showPasswordReset()" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 10px;">
                        🔑 Reset Password
                    </button>
                    <button class="logout-button" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <!-- Password Reset Modal -->
        <div class="password-reset-modal hidden" id="passwordResetModal" onclick="handleModalClick(event)" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        ">
            <div style="
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            ">
                <h3 style="text-align: center; color: #333; margin-bottom: 20px;">🔑 Reset Password</h3>
                
                <form onsubmit="handlePasswordReset(event)">
                    <input type="text" name="username" id="resetUsername" placeholder="Username" required style="
                        width: 100%;
                        padding: 12px;
                        margin-bottom: 15px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        font-size: 1rem;
                        box-sizing: border-box;
                    ">
                    
                    <input type="password" name="current_password" placeholder="Current Password" required style="
                        width: 100%;
                        padding: 12px;
                        margin-bottom: 15px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        font-size: 1rem;
                        box-sizing: border-box;
                    ">
                    
                    <input type="password" name="new_password" placeholder="New Password (min 6 characters)" required minlength="6" style="
                        width: 100%;
                        padding: 12px;
                        margin-bottom: 15px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        font-size: 1rem;
                        box-sizing: border-box;
                    ">
                    
                    <input type="password" name="confirm_password" placeholder="Confirm New Password" required minlength="6" style="
                        width: 100%;
                        padding: 12px;
                        margin-bottom: 20px;
                        border: 1px solid #ddd;
                        border-radius: 8px;
                        font-size: 1rem;
                        box-sizing: border-box;
                    ">
                    
                    <div style="display: flex; gap: 10px;">
                        <button type="submit" style="
                            flex: 1;
                            background: linear-gradient(45deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            padding: 12px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                            transition: transform 0.2s ease;
                        " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                            Reset Password
                        </button>
                        
                        <button type="button" onclick="hidePasswordReset()" style="
                            flex: 1;
                            background: #6c757d;
                            color: white;
                            border: none;
                            padding: 12px;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 1rem;
                        ">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="nav-section hidden" id="navSection">
            <!-- Initial Capital Section -->
            <div style="background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 20px; border: 1px solid #e9ecef;">
                <h4 style="margin-bottom: 10px; color: #333; font-size: 0.95rem;">💰 Initial Capital</h4>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #666; font-size: 0.9rem;">$</span>
                    <input type="number" id="initialCapitalInput" placeholder="25000" min="100" step="100" 
                           style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;"
                           onchange="updateInitialCapital()">
                    <button onclick="updateInitialCapital()" style="
                        background: linear-gradient(45deg, #007bff, #0056b3);
                        color: white;
                        border: none;
                        padding: 8px 12px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-size: 0.85rem;
                        white-space: nowrap;
                    ">Update</button>
                </div>
                <p style="margin: 8px 0 0 0; font-size: 0.8rem; color: #666;">
                    Set your starting capital for accurate return calculations
                </p>
            </div>
            
            <h4 style="margin-bottom: 15px; color: #333;">📊 Quick Actions</h4>
            <button class="nav-button" id="viewDatabaseBtn" onclick="loadDatabaseAnalysis()">
                📈 View Complete Trading Analysis
            </button>
            <button class="nav-button" id="quickDailyAnalysisBtn" onclick="quickDailyAnalysis()" style="background: linear-gradient(45deg, #667eea, #764ba2);">
                📅 Daily Performance Analysis
            </button>
            <button class="nav-button" onclick="showUploadSection()" style="background: linear-gradient(45deg, #28a745, #20c997);">
                📁 Upload New Data
            </button>
            <button class="nav-button" onclick="confirmDeleteAllTrades()" style="background: linear-gradient(45deg, #dc3545, #c82333); margin-top: 10px;">
                🗑️ Delete All Trades
            </button>
        </div>
        
        <div class="upload-section hidden" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📈</div>
                <div class="upload-text">
                    <h3>Upload TradeSteward CSV File</h3>
                    <p>Drop your TradeSteward performance log CSV file here or click to browse</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".csv" />
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your trading data...</p>
            </div>
        </div>
        
        <div class="results hidden" id="results">
            <h2>📊 Cumulative Trading Analysis</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                <em>Showing comprehensive analysis across all uploaded trading data</em>
            </p>
            
            <!-- Strategy Filter Section -->
            <div class="strategy-filter-section" id="strategyFilterSection" style="display: none;">
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 25px; border: 2px solid #e9ecef;">
                    <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">🎯</span>
                        Strategy Filter
                        <span style="margin-left: auto; font-size: 12px; color: #666;" id="selectedStrategiesCount"></span>
                    </h4>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
                        Select which strategies to include in the overall metrics and analysis:
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button onclick="selectAllStrategies()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            Select All
                        </button>
                        <button onclick="deselectAllStrategies()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            Deselect All
                        </button>
                        <button onclick="applyStrategyFilter()" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            Apply Filter
                        </button>
                    </div>
                    <div class="strategy-checkboxes" id="strategyCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <!-- Strategy checkboxes will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be populated by JavaScript -->
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button id="dailyAnalysisBtn" onclick="showDailyAnalysis().catch(err => console.error('Daily analysis error:', err))" style="
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                    transition: all 0.3s ease;
                    margin-right: 15px;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.3)'">
                    📅 Daily Performance Analysis
                </button>
                <button id="backToOverallBtn" onclick="showOverallAnalysis()" style="
                    background: linear-gradient(45deg, #6c757d, #495057);
                    color: white;
                    border: none;
                    padding: 12px 30px;
                    border-radius: 25px;
                    font-size: 16px;
                    font-weight: bold;
                    cursor: pointer;
                    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
                    transition: all 0.3s ease;
                    display: none;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(108, 117, 125, 0.4)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(108, 117, 125, 0.3)'">
                    📊 Back to Overall Analysis
                </button>
            </div>
            
            <div class="strategy-section" id="strategySection">
                <h3>📈 Strategy Performance Breakdown <span style="font-size: 0.8em; color: #666; font-weight: normal;">(Cumulative Data)</span></h3>
                <table class="strategy-table" id="strategyTable">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Total P&L</th>
                            <th>Total Commissions</th>
                            <th>Avg P&L</th>
                            <th>Avg Commission</th>
                            <th>Trade Count</th>
                            <th>Avg %</th>
                        </tr>
                    </thead>
                    <tbody id="strategyTableBody">
                        <!-- Strategy data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="charts-section" id="chartsSection">
                <!-- Charts will be populated by JavaScript -->
            </div>
            
            <!-- Daily Analysis Section (Hidden by default) -->
            <div id="dailyAnalysisSection" style="display: none;">
                <h2 style="text-align: center; margin-bottom: 30px; color: #333;">📅 Daily Performance Analysis</h2>
                
                <div id="dailyMetricsGrid" class="metrics-grid">
                    <!-- Daily metrics will be populated by JavaScript -->
                </div>
                
                <div class="daily-controls" style="text-align: center; margin: 30px 0;">
                    <label style="margin-right: 15px;">
                        <input type="date" id="startDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        Start Date
                    </label>
                    <label style="margin-right: 15px;">
                        <input type="date" id="endDate" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                        End Date
                    </label>
                    <button onclick="filterDailyData()" style="
                        background: #667eea;
                        color: white;
                        border: none;
                        padding: 8px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        margin-left: 10px;
                    ">Apply Filter</button>
                </div>
                
                <div class="daily-table-section">
                    <h3>📊 Day-by-Day Performance</h3>
                    <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 10px;">
                        <table class="strategy-table" id="dailyTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Trades</th>
                                    <th>Daily P&L</th>
                                    <th>Cumulative P&L</th>
                                    <th>Win Rate</th>
                                    <th>Strategies</th>
                                </tr>
                            </thead>
                            <tbody id="dailyTableBody">
                                <!-- Daily data will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="daily-charts-section" id="dailyChartsSection" style="margin-top: 30px;">
                    <!-- Daily charts will be populated by JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="error" id="error" style="display: none;">
            <!-- Error messages will be shown here -->
        </div>
    </div>

    <script>
        // Authentication state
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        
        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                validateToken();
            } else {
                showAuthSection();
            }
        });
        
        // Authentication functions
        function showLogin() {
            document.querySelector('.auth-tab.active').classList.remove('active');
            document.querySelector('.auth-tab').classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('newPasswordForm').classList.add('hidden');
        }
        
        function showRegister() {
            document.querySelector('.auth-tab.active').classList.remove('active');
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            document.getElementById('newPasswordForm').classList.add('hidden');
        }
        
        function showForgotPassword() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
            document.getElementById('newPasswordForm').classList.add('hidden');
        }
        
        async function handleForgotPassword(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const username = formData.get('username');
            
            try {
                showLoading();
                const response = await fetch('/forgot-password', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    if (result.allow_reset) {
                        // Store username for the next form
                        document.getElementById('resetUsernameHidden').value = username;
                        
                        // Show new password form
                        document.getElementById('forgotPasswordForm').classList.add('hidden');
                        document.getElementById('newPasswordForm').classList.remove('hidden');
                        hideLoading();
                        
                        alert(result.message + ". Please enter your new password below.");
                    } else {
                        hideLoading();
                        alert(result.message);
                    }
                } else {
                    hideLoading();
                    showError(result.detail || 'Failed to initiate password reset');
                }
            } catch (error) {
                hideLoading();
                showError('Network error during password reset initiation');
            }
        }
        
        async function handleNewPassword(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const username = formData.get('username');
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            try {
                showLoading();
                
                const resetData = new FormData();
                resetData.append('username', username);
                resetData.append('new_password', newPassword);
                
                const response = await fetch('/update-forgotten-password', {
                    method: 'POST',
                    body: resetData
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    hideLoading();
                    alert('Password updated successfully! You can now login with your new password.');
                    
                    // Clear form and go back to login
                    event.target.reset();
                    setTimeout(() => {
                        showLogin();
                    }, 2000);
                } else {
                    hideLoading();
                    showError(result.detail || 'Failed to update password');
                }
            } catch (error) {
                hideLoading();
                showError('Network error during password update');
            }
        }
        
        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('navSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
        }
        
        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('navSection').classList.remove('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
            
            // Load user's initial capital setting
            loadInitialCapital();
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = { user_id: data.user_id, username: data.username };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('username').textContent = data.username;
                    showMainApp();
                    hideError();
                } else {
                    showError(data.detail || 'Login failed');
                }
            } catch (err) {
                showError('Network error during login');
            }
        }
        
        async function handleRegister(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = { user_id: data.user_id, username: data.username };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('username').textContent = data.username;
                    showMainApp();
                    hideError();
                } else {
                    showError(data.detail || 'Registration failed');
                }
            } catch (err) {
                showError('Network error during registration');
            }
        }
        
        async function validateToken() {
            try {
                const response = await fetch('/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('username').textContent = data.username;
                    showMainApp();
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }
        
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showAuthSection();
            hideError();
        }
        
        // Password reset functions
        function showPasswordReset() {
            const modal = document.getElementById('passwordResetModal');
            const usernameField = document.getElementById('resetUsername');
            
            // Pre-fill the username
            if (currentUser && currentUser.username) {
                usernameField.value = currentUser.username;
            }
            
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }
        
        function hidePasswordReset() {
            const modal = document.getElementById('passwordResetModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            
            // Clear form
            const form = modal.querySelector('form');
            form.reset();
            
            // Re-fill username
            if (currentUser && currentUser.username) {
                document.getElementById('resetUsername').value = currentUser.username;
            }
        }
        
        async function handlePasswordReset(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            // Client-side validation
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                showError('New password must be at least 6 characters long');
                return;
            }
            
            // Disable submit button
            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Resetting...';
            
            try {
                const response = await fetch('/reset-password', {
                    method: 'POST',
                    body: formData,
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    hidePasswordReset();
                    hideError();
                    
                    // Show success message
                    alert('✅ Password reset successfully!\n\nYour password has been updated. You will need to log in again with your new password.');
                    
                    // Log out user to force re-authentication with new password
                    logout();
                } else {
                    showError(data.detail || 'Password reset failed');
                }
            } catch (err) {
                showError('Network error during password reset. Please try again.');
            } finally {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
        
        // Handle modal click to close when clicking outside
        function handleModalClick(event) {
            if (event.target.id === 'passwordResetModal') {
                hidePasswordReset();
            }
        }
        
        // Update API calls to include authorization header
        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${authToken}`
            };
        }
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        async function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('Please upload a CSV file.');
                return;
            }
            
            // Reset state for new data upload
            isDataLoaded = false;
            isDailyViewActive = false;
            stopDailyViewProtection();
            hideError();
            showLoading();
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Upload response:', data); // Debug log
                    displayResults(data);
                } else {
                    showError(`Error: ${data.detail || 'Unknown error occurred'}`);
                }
            } catch (err) {
                showError(`Network error: ${err.message}`);
            } finally {
                hideLoading();
            }
        }
        
        function displayResults(data, isDatabaseView = false) {
            console.log('🎨 displayResults called with isDatabaseView:', isDatabaseView);
            console.log('🔍 Current state - isDailyViewActive:', isDailyViewActive, 'switchToDailyAfterLoad:', switchToDailyAfterLoad);
            console.log('📊 Data object keys:', Object.keys(data));
            console.log('📊 Full data:', data);
            
            const metrics = data.metrics;
            const plots = data.plots;
            
            console.log('📈 Metrics object:', metrics);
            console.log('🎭 Plots array:', plots);
            
            if (!metrics) {
                console.error('❌ No metrics data in response');
                showError('No metrics data received from server');
                return;
            }
            
            console.log('💰 Commission metrics check:', {
                total_commissions: metrics.total_commissions,
                avg_commission_per_trade: metrics.avg_commission_per_trade,
                commission_percentage: metrics.commission_percentage
            });
            
            // Store current analysis data for filtering
            currentAnalysisData = data;
            
            // Populate strategy filter if this is the initial load
            if (isDatabaseView && metrics.strategy_performance) {
                const strategies = Object.keys(metrics.strategy_performance);
                console.log('🎯 Populating strategy filter with:', strategies);
                populateStrategyFilter(strategies);
            }
            
            // Account filter will be populated after charts are rendered
            
            // Remove any existing merge info
            const existingMergeInfo = document.querySelector('.merge-info');
            if (existingMergeInfo) {
                existingMergeInfo.remove();
            }
            
            // Show merge statistics if available
            if (data.new_trades !== undefined || data.updated_trades !== undefined || data.duplicate_trades !== undefined) {
                const mergeInfo = document.createElement('div');
                mergeInfo.className = 'info-section merge-info';
                
                let uploadMessage = '';
                if (isDatabaseView) {
                    uploadMessage = `📊 Displaying complete analysis of all trading data in your database`;
                } else if (data.new_trades > 0) {
                    uploadMessage = `✅ Successfully added ${data.new_trades} new trade${data.new_trades === 1 ? '' : 's'} to your database!`;
                } else if (data.updated_trades > 0) {
                    uploadMessage = `🔄 Updated ${data.updated_trades} existing trade${data.updated_trades === 1 ? '' : 's'} with latest data.`;
                } else {
                    uploadMessage = `ℹ️ No new trades found in this upload.`;
                }
                
                let cardsHtml = '';
                if (!isDatabaseView) {
                    cardsHtml = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                            <div style="text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #27ae60;">${data.new_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">New</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #f39c12;">${data.updated_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">Updated</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f8d7da; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">${data.duplicate_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">Skipped</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #d1ecf1; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #17a2b8;">${data.total_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">Total in DB</div>
                            </div>
                        </div>`;
                } else {
                    cardsHtml = `
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; margin-top: 15px;">
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;">${data.total_trades || 0}</div>
                            <div style="font-size: 1.2em;">Total Trades in Database</div>
                            <div style="font-size: 1em; margin-top: 5px; opacity: 0.9;">Date Range: ${data.date_range || 'N/A'}</div>
                        </div>`;
                }
                
                mergeInfo.innerHTML = `
                    <h4>${isDatabaseView ? '📊 Database Analysis:' : `📊 Upload Results for "${data.filename || 'file'}":`}</h4>
                    <p style="font-size: 1.1em; color: #2c3e50; margin-bottom: 10px;">${uploadMessage}</p>
                    ${cardsHtml}
                    <p style="margin-top: 15px; font-style: italic; color: #666; text-align: center;">
                        📈 Analysis below includes ALL trades from your complete trading history
                    </p>
                `;
                
                // Insert before the metrics grid
                const metricsGrid = document.getElementById('metricsGrid');
                metricsGrid.parentNode.insertBefore(mergeInfo, metricsGrid);
            }
            
            // Add header for metrics section
            const metricsContainer = document.getElementById('metricsGrid').parentNode;
            let existingHeader = metricsContainer.querySelector('.metrics-header');
            if (existingHeader) {
                existingHeader.remove();
            }
            
            const metricsHeader = document.createElement('h3');
            metricsHeader.className = 'metrics-header';
            metricsHeader.style.cssText = 'text-align: center; color: #333; margin: 20px 0 15px 0; border-bottom: 2px solid #667eea; padding-bottom: 10px;';
            metricsHeader.innerHTML = '📊 Overall Performance Metrics <span style="font-size: 0.8em; color: #666; font-weight: normal;">(All Trading Data)</span>';
            
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.parentNode.insertBefore(metricsHeader, metricsGrid);
            
            // Display key metrics
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value ${metrics.total_pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.total_pnl.toLocaleString()}
                    </div>
                    <div class="metric-label">Total Net P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.total_gross_pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.total_gross_pnl.toLocaleString()}
                    </div>
                    <div class="metric-label">Total Gross P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        $${(metrics.total_commissions || 0).toLocaleString()}
                    </div>
                    <div class="metric-label">Total Commissions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.total_trades}</div>
                    <div class="metric-label">Total Trades</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        $${(metrics.avg_commission_per_trade || 0).toFixed(2)}
                    </div>
                    <div class="metric-label">Avg Commission/Trade</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        ${(metrics.commission_percentage || 0).toFixed(1)}%
                    </div>
                    <div class="metric-label">Commission %</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.win_rate >= 50 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.win_rate}%
                    </div>
                    <div class="metric-label">Win Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.profit_factor >= 1 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.profit_factor === Infinity ? '∞' : metrics.profit_factor}
                    </div>
                    <div class="metric-label">Profit Factor</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.max_drawdown >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.max_drawdown.toLocaleString()}
                    </div>
                    <div class="metric-label">Max Drawdown</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.sharpe_ratio >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.sharpe_ratio}
                    </div>
                    <div class="metric-label">Sharpe Ratio <span style="font-size: 0.8em; color: #999;">(RF: ${metrics.risk_free_rate ? (metrics.risk_free_rate * 100).toFixed(1) : 4.3}%)</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${(metrics.mar_ratio || 0) >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${(metrics.mar_ratio || 0).toFixed(2)}
                    </div>
                    <div class="metric-label">MAR Ratio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${(metrics.sortino_ratio || 0) >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.sortino_ratio === Infinity ? '∞' : (metrics.sortino_ratio || 0).toFixed(2)}
                    </div>
                    <div class="metric-label">Sortino Ratio <span style="font-size: 0.8em; color: #999;">(RF: ${metrics.risk_free_rate ? (metrics.risk_free_rate * 100).toFixed(1) : 4.3}%)</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${(metrics.upi || 0) >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${(metrics.upi || 0).toFixed(2)}
                    </div>
                    <div class="metric-label">UPI <span style="font-size: 0.8em; color: #999;">(RF: ${metrics.risk_free_rate ? (metrics.risk_free_rate * 100).toFixed(1) : 4.3}%)</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-positive">
                        $${metrics.avg_winner.toLocaleString()}
                    </div>
                    <div class="metric-label">Avg Winner</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        $${metrics.avg_loser.toLocaleString()}
                    </div>
                    <div class="metric-label">Avg Loser</div>
                </div>
            `;
            
            // Display strategy performance table
            const strategyTableBody = document.getElementById('strategyTableBody');
            let strategyRows = '';
            
            const strategyPerf = metrics.strategy_performance;
            for (const strategy in strategyPerf) {
                const strategyData = strategyPerf[strategy];
                const totalPnL = strategyData.total_pnl;
                const totalCommissions = strategyData.total_commissions || 0;
                const avgPnL = strategyData.avg_pnl;
                const avgCommission = strategyData.avg_commission || 0;
                const count = strategyData.trade_count;
                const avgPercent = strategyData.avg_percentage || 0;
                
                strategyRows += `
                    <tr>
                        <td>${strategy}</td>
                        <td class="${totalPnL >= 0 ? 'metric-positive' : 'metric-negative'}">
                            $${totalPnL.toLocaleString()}
                        </td>
                        <td class="metric-negative">
                            $${totalCommissions.toLocaleString()}
                        </td>
                        <td class="${avgPnL >= 0 ? 'metric-positive' : 'metric-negative'}">
                            $${avgPnL.toFixed(2)}
                        </td>
                        <td class="metric-negative">
                            $${avgCommission.toFixed(2)}
                        </td>
                        <td>${count}</td>
                        <td class="${avgPercent >= 0 ? 'metric-positive' : 'metric-negative'}">
                            ${avgPercent.toFixed(1)}%
                        </td>
                    </tr>
                `;
            }
            strategyTableBody.innerHTML = strategyRows;
            
            // Display charts with hybrid approach (static images + interactive overlays)
            const chartsSection = document.getElementById('chartsSection');
            chartsSection.innerHTML = '<h3 style="text-align: center; color: #333; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">📊 Visual Analysis <span style="font-size: 0.8em; color: #666; font-weight: normal;">(Hover for Details)</span></h3>';
            
            // Always use static charts with interactive overlays
            renderHybridCharts(plots, data.interactive_charts || {})
            
            // Populate account filter AFTER charts are rendered (so the element exists)
            if (data.available_accounts && data.available_accounts.length > 0) {
                console.log('✅ Calling populateAccountFilter AFTER chart rendering with:', data.available_accounts);
                populateAccountFilter(data.available_accounts);
            }
            
            // Mark data as loaded
            isDataLoaded = true;
            
            // Always make results container visible
            results.classList.remove('hidden');
            results.style.display = 'block';
            
            // Show results section if not switching to daily view and not currently in daily view
            if (!switchToDailyAfterLoad && !isDailyViewActive) {
                console.log('🎯 About to show overall results section');
                results.scrollIntoView({ behavior: 'smooth' });
                console.log('📜 Scrolled to overall results section');
            } else if (switchToDailyAfterLoad) {
                console.log('✅ Made results container visible for pending daily view switch');
            } else if (isDailyViewActive) {
                console.log('✅ Results container visible, daily view remains active');
            }
        }
        
        function showLoading() {
            loading.style.display = 'block';
            // Don't hide results if we're in daily view
            if (!isDailyViewActive) {
                results.style.display = 'none';
            } else {
                console.log('🛡️ Protected results section from hiding during daily view');
            }
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        function showError(message) {
            error.innerHTML = `<strong>Error:</strong> ${message}`;
            error.style.display = 'block';
            // Don't hide results if we're in daily view
            if (!isDailyViewActive) {
                results.style.display = 'none';
            } else {
                console.log('🛡️ Protected results section from hiding during daily view (error)');
            }
        }
        
        function hideError() {
            error.style.display = 'none';
        }

        async function loadDatabaseAnalysis() {
            console.log('🚀 loadDatabaseAnalysis called');
            
            // If called directly (not from quickDailyAnalysis), ensure we switch to overall view
            if (!switchToDailyAfterLoad) {
                isDailyViewActive = false;
                console.log('📊 Will show overall analysis view after load');
            }
            
            hideError();
            showLoading();
            
            const button = document.getElementById('viewDatabaseBtn');
            button.disabled = true;
            button.textContent = '📊 Loading Analysis...';
            
            try {
                console.log('📡 Making request to /database-analysis');
                const response = await fetch('/database-analysis', {
                    headers: getAuthHeaders()
                });
                
                console.log('📨 Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Parsed response data:', data);
                
                if (data.success) {
                    console.log('✅ Success response - calling displayResults');
                    console.log('📈 Metrics preview:', data.metrics ? Object.keys(data.metrics).slice(0, 5) : 'NO METRICS');
                    
                    // Modify data to show it's from database
                    data.filename = 'Complete Database';
                    data.new_trades = 0;
                    data.updated_trades = 0;
                    data.duplicate_trades = 0;
                    
                    console.log('🎯 About to call displayResults with:', data);
                    displayResults(data, true); // Pass true to indicate this is database view
                    console.log('✅ displayResults completed');
                    
                    // Hide upload section when viewing complete trading analysis
                    console.log('📤 Hiding upload section after loading complete analysis');
                    document.getElementById('uploadSection').classList.add('hidden');
                } else {
                    console.log('❌ API returned success=false');
                    showError(`Error: ${data.detail || 'Unknown error occurred'}`);
                }
            } catch (err) {
                console.error('❌ Error in loadDatabaseAnalysis:', err);
                if (err.message.includes('404')) {
                    showError('No trading data found in database. Please upload a CSV file first.');
                } else {
                    showError(`Network error: ${err.message}`);
                }
            } finally {
                console.log('🏁 loadDatabaseAnalysis finally block');
                hideLoading();
                button.disabled = false;
                button.textContent = '📈 View Complete Trading Analysis';
            }
        }

        // Initial Capital Management
        async function updateInitialCapital() {
            const input = document.getElementById('initialCapitalInput');
            const initialCapital = parseFloat(input.value);
            
            if (!initialCapital || initialCapital < 100) {
                alert('Please enter a valid initial capital amount (minimum $100)');
                return;
            }
            
            try {
                const response = await fetch('/set-initial-capital', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        ...getAuthHeaders()
                    },
                    body: `initial_capital=${initialCapital}`
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    alert(`Initial capital updated to $${initialCapital.toLocaleString()}`);
                    
                    // If analysis is currently loaded, refresh it to reflect new calculations
                    if (isDataLoaded) {
                        console.log('Refreshing analysis with new initial capital...');
                        loadDatabaseAnalysis();
                    }
                } else {
                    alert(`Failed to update initial capital: ${result.detail || 'Unknown error'}`);
                }
            } catch (error) {
                alert('Network error updating initial capital');
                console.error('Error updating initial capital:', error);
            }
        }
        
        async function loadInitialCapital() {
            try {
                const response = await fetch('/get-initial-capital', {
                    headers: getAuthHeaders()
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const input = document.getElementById('initialCapitalInput');
                    if (result.initial_capital) {
                        input.value = result.initial_capital;
                    }
                }
            } catch (error) {
                console.error('Error loading initial capital:', error);
            }
        }

        function showUploadSection() {
            const uploadSection = document.getElementById('uploadSection');
            const results = document.getElementById('results');
            
            // Reset state when switching to upload
            isDataLoaded = false;
            isDailyViewActive = false;
            stopDailyViewProtection();
            
            // Show upload section by removing hidden class and setting display
            uploadSection.classList.remove('hidden');
            uploadSection.style.display = 'block';
            results.style.display = 'none';
            
            console.log('📤 Upload section shown - user can upload new data');
            
            // Scroll to upload section
            uploadSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Strategy filtering functionality
        let currentAnalysisData = null;
        let selectedStrategies = new Set();

        function populateStrategyFilter(strategies) {
            const checkboxContainer = document.getElementById('strategyCheckboxes');
            const filterSection = document.getElementById('strategyFilterSection');
            
            if (!strategies || strategies.length === 0) {
                filterSection.style.display = 'none';
                return;
            }
            
            // Clear existing checkboxes
            checkboxContainer.innerHTML = '';
            
            // Initialize all strategies as selected
            selectedStrategies.clear();
            strategies.forEach(strategy => selectedStrategies.add(strategy));
            
            // Create checkboxes for each strategy
            strategies.forEach(strategy => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px; border: 1px solid #ddd;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `strategy_${strategy.replace(/\s+/g, '_')}`;
                checkbox.checked = true;
                checkbox.style.marginRight = '8px';
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedStrategies.add(strategy);
                    } else {
                        selectedStrategies.delete(strategy);
                    }
                    updateSelectedCount();
                });
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = strategy;
                label.style.cssText = 'flex: 1; cursor: pointer; font-size: 14px;';
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });
            
            updateSelectedCount();
            filterSection.style.display = 'block';
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selectedStrategiesCount');
            const total = document.querySelectorAll('#strategyCheckboxes input[type="checkbox"]').length;
            const selected = selectedStrategies.size;
            countElement.textContent = `${selected}/${total} selected`;
        }
        
        function selectAllStrategies() {
            const checkboxes = document.querySelectorAll('#strategyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const strategy = checkbox.nextElementSibling.textContent;
                selectedStrategies.add(strategy);
            });
            updateSelectedCount();
        }
        
        function deselectAllStrategies() {
            const checkboxes = document.querySelectorAll('#strategyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedStrategies.clear();
            updateSelectedCount();
        }
        
        async function applyStrategyFilter() {
            if (!currentAnalysisData) {
                showError('No analysis data available to filter');
                return;
            }
            
            if (selectedStrategies.size === 0) {
                showError('Please select at least one strategy');
                return;
            }
            
            // Show loading
            showLoading();
            
            try {
                const strategiesArray = Array.from(selectedStrategies);
                const response = await fetch('/database-analysis-filtered', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        strategies: strategiesArray
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Update the display with filtered data
                    data.filename = `Filtered Analysis (${strategiesArray.length} strategies)`;
                    data.new_trades = 0;
                    data.updated_trades = 0;
                    data.duplicate_trades = 0;
                    
                    displayResults(data, true);
                } else {
                    showError(`Error: ${data.detail || 'Unknown error occurred'}`);
                }
            } catch (err) {
                showError(`Network error: ${err.message}`);
            } finally {
                hideLoading();
            }
        }

        // Account filtering functionality for commission analysis
        function populateAccountFilter(accounts) {
            console.log('🏦 populateAccountFilter called with:', accounts);
            const accountSelect = document.getElementById('accountFilter');
            console.log('accountFilter element found:', !!accountSelect);
            if (!accountSelect) {
                console.error('❌ accountFilter element not found!');
                return;
            }
            
            // Clear existing options except "All Accounts"
            accountSelect.innerHTML = '<option value="all">All Accounts</option>';
            console.log('🧹 Cleared accountFilter, current options:', accountSelect.options.length);
            
            // Add account options with obfuscated display names
            accounts.forEach((account, index) => {
                console.log(`➕ Adding account ${index + 1}:`, account);
                const option = document.createElement('option');
                option.value = account.account_num;  // Use real account number for filtering
                option.textContent = `Account ${account.account_display} (${account.trade_count} trades)`;  // Use obfuscated display
                accountSelect.appendChild(option);
                console.log(`✅ Added option: ${option.textContent}`);
            });
            
            console.log('🏦 Final accountFilter options count:', accountSelect.options.length);
            console.log('🏦 Final options:', Array.from(accountSelect.options).map(opt => opt.textContent));
        }
        
        async function applyAccountFilter() {
            const accountSelect = document.getElementById('accountFilter');
            const selectedAccount = accountSelect.value;
            
            if (!currentAnalysisData) {
                showError('No analysis data available to filter');
                return;
            }
            
            console.log('🏦 Applying account filter:', selectedAccount);
            
            // Show loading on just the commission chart
            const chartContainer = document.getElementById('commissionChartContainer');
            if (chartContainer) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><div class="spinner" style="display: inline-block; margin-bottom: 10px;"></div><br>Loading commission analysis...</div>';
            }
            
            try {
                const response = await fetch('/commission-analysis-by-account', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_num: selectedAccount === 'all' ? null : selectedAccount
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.commission_plot) {
                    // Update only the commission chart
                    chartContainer.innerHTML = `<img src="/uploads/${data.commission_plot}" alt="Commission Analysis" />`;
                    console.log('✅ Commission chart updated for account:', selectedAccount);
                } else {
                    throw new Error(data.detail || 'Failed to generate commission chart');
                }
            } catch (err) {
                console.error('❌ Error filtering by account:', err);
                chartContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading commission analysis. Please try again.</div>';
            }
        }

        // Delete all trades functionality
        function confirmDeleteAllTrades() {
            const userConfirm = confirm(
                '⚠️ WARNING: This will permanently delete ALL your trading data!\n\n' +
                'Are you sure you want to delete all trades? This action cannot be undone.\n\n' +
                'Click OK to proceed or Cancel to abort.'
            );
            
            if (userConfirm) {
                const doubleConfirm = confirm(
                    '🚨 FINAL CONFIRMATION 🚨\n\n' +
                    'This will PERMANENTLY DELETE all your trading data.\n' +
                    'You will lose all analysis history, metrics, and uploaded trades.\n\n' +
                    'Are you absolutely sure you want to continue?'
                );
                
                if (doubleConfirm) {
                    deleteAllTrades();
                }
            }
        }
        
        async function deleteAllTrades() {
            if (!currentUser) {
                showError('You must be logged in to delete trades');
                return;
            }
            
            console.log('🗑️ Starting delete all trades process...');
            
            // Show loading indicator
            const deleteButton = document.querySelector('button[onclick="confirmDeleteAllTrades()"]');
            const originalText = deleteButton.textContent;
            deleteButton.disabled = true;
            deleteButton.textContent = '🔄 Deleting...';
            deleteButton.style.background = '#6c757d';
            
            try {
                const response = await fetch('/delete-all-trades', {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ All trades deleted successfully');
                    
                    // Reset state after deleting all data
                    isDataLoaded = false;
                    isDailyViewActive = false;
                    stopDailyViewProtection();
                    
                    // Clear the results section
                    const results = document.getElementById('results');
                    if (results) {
                        results.style.display = 'none';
                        results.classList.add('hidden');
                    }
                    
                    // Show success message
                    alert(`✅ Success!\n\nDeleted ${data.deleted_count} trades from your account.\nYou can now upload new CSV files to start fresh.`);
                    
                    // Show upload section
                    showUploadSection();
                    
                } else {
                    throw new Error(data.detail || 'Failed to delete trades');
                }
                
            } catch (err) {
                console.error('❌ Error deleting trades:', err);
                alert(`❌ Error deleting trades:\n\n${err.message}\n\nPlease try again or contact support if the problem persists.`);
            } finally {
                // Restore button
                deleteButton.disabled = false;
                deleteButton.textContent = originalText;
                deleteButton.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
            }
        }

        // Hybrid chart rendering (static images + interactive overlays)
        function renderHybridCharts(plots, chartData) {
            const chartsSection = document.getElementById('chartsSection');
            
            const titles = [
                'Cumulative P&L Performance',
                'Strategy Analysis', 
                'Risk & Performance Metrics',
                'Commission Analysis'
            ];
            
            let chartsHtml = '';
            plots.forEach((plotFile, index) => {
                const chartId = `chart-${index}`;
                
                // Special handling for Commission Analysis chart
                if (index === 3) {
                    chartsHtml += `
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">${titles[index]}</h3>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="accountFilter" style="font-size: 14px; color: #666;">Filter by Account:</label>
                                    <select id="accountFilter" onchange="applyAccountFilter()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; background: white; font-size: 14px;">
                                        <option value="all">All Accounts</option>
                                    </select>
                                </div>
                            </div>
                            <div id="commissionChartContainer" style="position: relative;">
                                <img src="/uploads/${plotFile}" alt="${titles[index]}" style="width: 100%; height: auto;" />
                                <div id="${chartId}-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
                            </div>
                        </div>
                    `;
                } else {
                    chartsHtml += `
                        <div class="chart-container" style="position: relative;">
                            <h3>${titles[index] || `Chart ${index + 1}`}</h3>
                            <img src="/uploads/${plotFile}" alt="${titles[index] || `Chart ${index + 1}`}" id="${chartId}-img" style="width: 100%; height: auto;" />
                            <div id="${chartId}-overlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
                        </div>
                    `;
                }
            });
            
            chartsSection.innerHTML += chartsHtml;
            
            // Add interactive overlays if chart data is available
            if (Object.keys(chartData).length > 0) {
                setTimeout(() => addInteractiveOverlays(chartData), 500);
            }
        }
        
        function addInteractiveOverlays(chartData) {
            console.log('🎯 Adding interactive overlays to charts...');
            
            // Create tooltip element
            const tooltip = document.createElement('div');
            tooltip.id = 'chart-tooltip';
            tooltip.style.cssText = `
                position: absolute;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-size: 12px;
                pointer-events: none;
                z-index: 1000;
                display: none;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                max-width: 250px;
            `;
            document.body.appendChild(tooltip);
            
            // Add interactive overlay to cumulative P&L chart (chart-0)
            if (chartData.cumulative_pnl) {
                addLineChartOverlay('chart-0-img', chartData.cumulative_pnl, tooltip);
            }
            
            // Add interactive overlay to strategy chart (chart-1) 
            if (chartData.strategy_performance) {
                addBarChartOverlay('chart-1-img', chartData.strategy_performance, tooltip);
            }
            
            // Add interactive overlay to P&L distribution (chart-2)
            if (chartData.pnl_distribution) {
                addHistogramOverlay('chart-2-img', chartData.pnl_distribution, tooltip);
            }
            
            // VIX scatter would be in chart-2 as well (risk analysis chart has multiple plots)
            if (chartData.vix_scatter) {
                addScatterOverlay('chart-2-img', chartData.vix_scatter, tooltip);
            }
        }
        
        function addLineChartOverlay(imgId, data, tooltip) {
            const img = document.getElementById(imgId);
            if (!img) return;
            
            img.addEventListener('mousemove', (e) => {
                const rect = img.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Approximate data point based on mouse position
                const dataIndex = Math.floor((x / rect.width) * data.x.length);
                if (dataIndex >= 0 && dataIndex < data.x.length) {
                    const date = data.x[dataIndex];
                    const cumPnL = data.y[dataIndex];
                    const dailyPnL = data.customdata[dataIndex];
                    
                    tooltip.innerHTML = `
                        <b>Date:</b> ${date}<br>
                        <b>Cumulative P&L:</b> $${cumPnL.toLocaleString('en-US', {minimumFractionDigits: 2})}<br>
                        <b>Daily P&L:</b> $${dailyPnL.toLocaleString('en-US', {minimumFractionDigits: 2})}
                    `;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                }
            });
            
            img.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }
        
        function addBarChartOverlay(imgId, data, tooltip) {
            const img = document.getElementById(imgId);
            if (!img) return;
            
            img.addEventListener('mousemove', (e) => {
                const rect = img.getBoundingClientRect();
                const x = e.clientX - rect.left;
                
                // Approximate bar based on mouse position
                const barIndex = Math.floor((x / rect.width) * data.x.length);
                if (barIndex >= 0 && barIndex < data.x.length) {
                    const strategy = data.x[barIndex];
                    const pnl = data.y[barIndex];
                    const tradeCount = data.customdata[barIndex];
                    
                    tooltip.innerHTML = `
                        <b>Strategy:</b> ${strategy}<br>
                        <b>Total P&L:</b> $${pnl.toLocaleString('en-US', {minimumFractionDigits: 2})}<br>
                        <b>Trade Count:</b> ${tradeCount}
                    `;
                    tooltip.style.display = 'block';
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY - 10) + 'px';
                }
            });
            
            img.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }
        
        function addHistogramOverlay(imgId, data, tooltip) {
            const img = document.getElementById(imgId);
            if (!img) return;
            
            img.addEventListener('mousemove', (e) => {
                const rect = img.getBoundingClientRect();
                const x = e.clientX - rect.left;
                
                // Show general P&L distribution info
                tooltip.innerHTML = `
                    <b>P&L Distribution</b><br>
                    <i>Hover over bars to see frequency data</i><br>
                    <b>Total Trades:</b> ${data.x.length}
                `;
                tooltip.style.display = 'block';
                tooltip.style.left = (e.clientX + 10) + 'px';
                tooltip.style.top = (e.clientY - 10) + 'px';
            });
            
            img.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }
        
        function addScatterOverlay(imgId, data, tooltip) {
            const img = document.getElementById(imgId);
            if (!img) return;
            
            img.addEventListener('mousemove', (e) => {
                tooltip.innerHTML = `
                    <b>Risk Analysis Charts</b><br>
                    <i>Multiple analysis views including:</i><br>
                    • P&L Distribution<br>
                    • VIX vs P&L Correlation<br>
                    • Market Performance Analysis
                `;
                tooltip.style.display = 'block';
                tooltip.style.left = (e.clientX + 10) + 'px';
                tooltip.style.top = (e.clientY - 10) + 'px';
            });
            
            img.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        }

        // State management for daily analysis
        let isDataLoaded = false;
        let switchToDailyAfterLoad = false;
        let isDailyViewActive = false;
        let dailyViewProtectionInterval = null;

        // Quick Daily Analysis from Nav Section
        async function quickDailyAnalysis() {
            console.log('🚀 Quick daily analysis requested');
            
            // Check if results are already loaded and have data
            const results = document.getElementById('results');
            const metricsGrid = document.getElementById('metricsGrid');
            
            console.log('🔍 Debug info:');
            console.log('- results element exists:', !!results);
            console.log('- results has hidden class:', results ? results.classList.contains('hidden') : 'no element');
            console.log('- results style.display:', results ? results.style.display : 'no element');
            console.log('- metricsGrid exists:', !!metricsGrid);
            console.log('- isDataLoaded flag:', isDataLoaded);
            
            // Better data detection - check for actual metric cards
            const hasMetricCards = metricsGrid && metricsGrid.querySelectorAll('.metric-card').length > 0;
            const isResultsVisible = results && !results.classList.contains('hidden') && results.style.display !== 'none';
            
            console.log('- hasMetricCards:', hasMetricCards);
            console.log('- isResultsVisible:', isResultsVisible);
            console.log('- isDataLoaded:', isDataLoaded);
            
            if (hasMetricCards && isResultsVisible && isDataLoaded) {
                // Data is already loaded, switch to daily view immediately
                console.log('📊 Data already loaded, switching to daily view');
                await showDailyAnalysis();
            } else {
                // Need to load database analysis first, then switch to daily view
                console.log('📈 Loading database analysis first...');
                
                // Update button state
                const button = document.getElementById('quickDailyAnalysisBtn');
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = '📅 Loading...';
                
                try {
                    // Set flag to switch to daily after load
                    switchToDailyAfterLoad = true;
                    
                    // Load database analysis and wait for completion
                    await loadDatabaseAnalysis();
                    
                    // Ensure data is marked as loaded
                    isDataLoaded = true;
                    
                    // Give a moment for DOM to settle, then switch to daily view
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    if (switchToDailyAfterLoad) {
                        console.log('🔄 Switching to daily analysis after load completion');
                        switchToDailyAfterLoad = false;
                        await showDailyAnalysis();
                    } else {
                        // Ensure we're in overall view if not switching to daily
                        isDailyViewActive = false;
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading database analysis:', error);
                    switchToDailyAfterLoad = false;
                    showError('Failed to load trading data for daily analysis. Please try again.');
                } finally {
                    // Restore button
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }

        // Daily Analysis View Functions
        async function showDailyAnalysis() {
            console.log('📅 Switching to daily analysis view');
            
            try {
                // Verify we have the required elements
                const dailyAnalysisSection = document.getElementById('dailyAnalysisSection');
                if (!dailyAnalysisSection) {
                    console.error('❌ Daily analysis section not found!');
                    showError('Daily analysis interface not available. Please refresh the page.');
                    return;
                }
                
                // Hide overall analysis elements
                const elementsToHide = [
                    { element: document.getElementById('metricsGrid')?.parentNode, name: 'metrics grid parent' },
                    { element: document.getElementById('strategySection'), name: 'strategy section' },
                    { element: document.getElementById('chartsSection'), name: 'charts section' },
                    { element: document.getElementById('dailyAnalysisBtn'), name: 'daily analysis button' }
                ];
                
                elementsToHide.forEach(({ element, name }) => {
                    if (element) {
                        element.style.display = 'none';
                        console.log(`✅ Hidden ${name}`);
                    }
                });
                
                // Show daily analysis elements and force results visibility
                const results = document.getElementById('results');
                results.style.setProperty('display', 'block', 'important');
                results.style.setProperty('visibility', 'visible', 'important');
                results.style.setProperty('opacity', '1', 'important');
                results.classList.remove('hidden');
                
                dailyAnalysisSection.style.setProperty('display', 'block', 'important');
                dailyAnalysisSection.style.setProperty('visibility', 'visible', 'important');
                dailyAnalysisSection.style.setProperty('opacity', '1', 'important');
                
                isDailyViewActive = true;
                console.log('✅ Shown daily analysis section and forced results visibility');
                
                const backToOverallBtn = document.getElementById('backToOverallBtn');
                if (backToOverallBtn) {
                    backToOverallBtn.style.display = 'inline-block';
                    console.log('✅ Shown back to overall button');
                }
                
                // Load daily analysis data with error handling
                console.log('📊 Loading daily analysis data...');
                try {
                    await loadDailyAnalysis();
                    console.log('✅ Daily analysis data loaded successfully');
                    
                    // Double-check that we're still in daily view after loading
                    setTimeout(() => {
                        if (isDailyViewActive) {
                            const dailySection = document.getElementById('dailyAnalysisSection');
                            if (dailySection && dailySection.style.display !== 'block') {
                                console.log('🔧 Fixing daily section visibility after load');
                                dailySection.style.display = 'block';
                            }
                        }
                    }, 50);
                    
                } catch (error) {
                    console.error('❌ Failed to load daily analysis data:', error);
                    showError('Failed to load daily analysis. The overall data is available, but daily breakdown could not be generated.');
                }
                
                // Scroll to daily analysis section
                dailyAnalysisSection.scrollIntoView({ behavior: 'smooth' });
                
                // Debug: Check state after loading
                setTimeout(() => {
                    console.log('🔍 Post-load debug check:');
                    console.log('- isDailyViewActive:', isDailyViewActive);
                    console.log('- dailyAnalysisSection.style.display:', dailyAnalysisSection.style.display);
                    console.log('- metricsGrid parent display:', document.getElementById('metricsGrid')?.parentNode?.style?.display);
                    console.log('- strategySection display:', document.getElementById('strategySection')?.style?.display);
                    console.log('- chartsSection display:', document.getElementById('chartsSection')?.style?.display);
                    
                    // Enhanced debugging for visibility
                    const results = document.getElementById('results');
                    const dailySection = document.getElementById('dailyAnalysisSection');
                    console.log('🔍 Enhanced visibility check:');
                    console.log('- results element:', results);
                    console.log('- results.style.display:', results?.style?.display);
                    console.log('- results.classList:', results?.classList.toString());
                    console.log('- results.offsetHeight:', results?.offsetHeight);
                    console.log('- dailySection element:', dailySection);
                    console.log('- dailySection.style.display:', dailySection?.style?.display);
                    console.log('- dailySection.offsetHeight:', dailySection?.offsetHeight);
                    console.log('- dailySection.scrollHeight:', dailySection?.scrollHeight);
                    console.log('- dailySection visible?:', dailySection?.offsetHeight > 0);
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error in showDailyAnalysis:', error);
                showError('An error occurred while switching to daily analysis view.');
            }
        }
        
        function showOverallAnalysis() {
            console.log('📊 Switching back to overall analysis view');
            
            // Reset daily view state and stop protection
            isDailyViewActive = false;
            stopDailyViewProtection();
            
            // Force show overall analysis with !important to override protection
            const metricsGridParent = document.getElementById('metricsGrid').parentNode;
            const strategySection = document.getElementById('strategySection');
            const chartsSection = document.getElementById('chartsSection');
            const dailyAnalysisBtn = document.getElementById('dailyAnalysisBtn');
            
            // Remove any !important hidden styles and show elements
            if (metricsGridParent) {
                metricsGridParent.style.setProperty('display', 'block', 'important');
                metricsGridParent.style.setProperty('visibility', 'visible', 'important');
            }
            if (strategySection) {
                strategySection.style.setProperty('display', 'block', 'important');
                strategySection.style.setProperty('visibility', 'visible', 'important');
            }
            if (chartsSection) {
                chartsSection.style.setProperty('display', 'block', 'important');
                chartsSection.style.setProperty('visibility', 'visible', 'important');
            }
            if (dailyAnalysisBtn) {
                dailyAnalysisBtn.style.setProperty('display', 'inline-block', 'important');
                dailyAnalysisBtn.style.setProperty('visibility', 'visible', 'important');
            }
            
            // Hide daily analysis
            const dailyAnalysisSection = document.getElementById('dailyAnalysisSection');
            const backToOverallBtn = document.getElementById('backToOverallBtn');
            
            if (dailyAnalysisSection) {
                dailyAnalysisSection.style.setProperty('display', 'none', 'important');
            }
            if (backToOverallBtn) {
                backToOverallBtn.style.setProperty('display', 'none', 'important');
            }
            
            console.log('✅ Switched back to overall view and set isDailyViewActive = false');
            
            // Scroll to the overall analysis
            setTimeout(() => {
                const results = document.getElementById('results');
                if (results) {
                    results.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        }
        
        async function loadDailyAnalysis() {
            console.log('📅 Loading daily analysis data...');
            
            // Show loading in daily section
            const dailyMetricsGrid = document.getElementById('dailyMetricsGrid');
            if (!dailyMetricsGrid) {
                throw new Error('Daily metrics grid element not found');
            }
            
            dailyMetricsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><div class="spinner" style="display: inline-block; margin-bottom: 10px;"></div><br>Loading daily analysis...</div>';
            
            try {
                const response = await fetch('/daily-analysis', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayDailyAnalysis(data);
                    console.log('✅ Daily analysis data processed successfully');
                } else {
                    throw new Error(data.detail || 'Failed to load daily analysis');
                }
            } catch (err) {
                console.error('❌ Error loading daily analysis:', err);
                dailyMetricsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading daily analysis. Please try again.</div>';
                throw err; // Re-throw to be caught by showDailyAnalysis
            }
        }
        
        function displayDailyAnalysis(data) {
            console.log('📅 Displaying daily analysis data:', data);
            
            // Ensure we stay in daily view mode
            isDailyViewActive = true;
            console.log('🔒 Locked isDailyViewActive = true in displayDailyAnalysis');
            
            // Display daily metrics
            const dailyMetricsGrid = document.getElementById('dailyMetricsGrid');
            const metrics = data.daily_metrics;
            
            console.log('🔍 Daily analysis debug:');
            console.log('- dailyMetricsGrid element:', dailyMetricsGrid);
            console.log('- metrics data:', metrics);
            console.log('- data.daily_data length:', data.daily_data?.length);
            
            dailyMetricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value metric-positive">
                        ${metrics.total_trading_days}
                    </div>
                    <div class="metric-label">Total Trading Days</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.avg_daily_pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.avg_daily_pnl.toLocaleString()}
                    </div>
                    <div class="metric-label">Avg Daily P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.best_day >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.best_day.toLocaleString()}
                    </div>
                    <div class="metric-label">Best Day</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.worst_day >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.worst_day.toLocaleString()}
                    </div>
                    <div class="metric-label">Worst Day</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.positive_days_pct >= 50 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.positive_days_pct}%
                    </div>
                    <div class="metric-label">Positive Days</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">
                        ${metrics.avg_trades_per_day.toFixed(1)}
                    </div>
                    <div class="metric-label">Avg Trades/Day</div>
                </div>
            `;
            
            // Display daily performance table
            displayDailyTable(data.daily_data);
            
            // Set date range filters
            if (data.date_range) {
                document.getElementById('startDate').value = data.date_range.start;
                document.getElementById('endDate').value = data.date_range.end;
            }
            
            // Verify content was populated
            console.log('🔍 Content check after population:');
            console.log('- dailyMetricsGrid.innerHTML length:', dailyMetricsGrid.innerHTML.length);
            console.log('- dailyTableBody rows:', document.getElementById('dailyTableBody')?.children?.length);
            console.log('- dailyAnalysisSection offsetHeight:', document.getElementById('dailyAnalysisSection')?.offsetHeight);
            
            // Final check to ensure daily view remains visible
            setTimeout(() => {
                const dailySection = document.getElementById('dailyAnalysisSection');
                if (dailySection && dailySection.style.display !== 'block') {
                    console.log('⚠️ Daily section visibility lost, restoring...');
                    dailySection.style.display = 'block';
                    isDailyViewActive = true;
                }
            }, 100);
            
            // Start monitoring for daily view protection
            startDailyViewProtection();
            
            // Force visibility after a delay
            setTimeout(() => {
                forceDailyViewVisibility();
            }, 200);
        }
        
        function displayDailyTable(dailyData) {
            const tableBody = document.getElementById('dailyTableBody');
            let tableRows = '';
            
            dailyData.forEach(day => {
                const pnlClass = day.daily_pnl >= 0 ? 'metric-positive' : 'metric-negative';
                tableRows += `
                    <tr>
                        <td>${day.date}</td>
                        <td>${day.trade_count}</td>
                        <td class="${pnlClass}">$${day.daily_pnl.toLocaleString()}</td>
                        <td class="${pnlClass}">$${day.cumulative_pnl.toLocaleString()}</td>
                        <td>${day.win_rate}%</td>
                        <td>${day.strategies.join(', ')}</td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableRows;
        }
        
        async function filterDailyData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (startDate > endDate) {
                alert('Start date must be before end date');
                return;
            }
            
            console.log('📅 Filtering daily data:', { startDate, endDate });
            
            // Show loading
            const dailyMetricsGrid = document.getElementById('dailyMetricsGrid');
            dailyMetricsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><div class="spinner"></div><br>Filtering data...</div>';
            
            try {
                const response = await fetch('/daily-analysis-filtered', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        start_date: startDate,
                        end_date: endDate
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    displayDailyAnalysis(data);
                } else {
                    throw new Error(data.detail || 'Failed to filter daily data');
                }
            } catch (err) {
                console.error('❌ Error filtering daily data:', err);
                dailyMetricsGrid.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error filtering data. Please try again.</div>';
            }
        }
        
        // Daily view protection functions
        let mutationObserver = null;
        
        function startDailyViewProtection() {
            stopDailyViewProtection(); // Clear any existing interval
            
            // Add MutationObserver to block any changes to results container
            const results = document.getElementById('results');
            if (results && window.MutationObserver) {
                mutationObserver = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            const target = mutation.target;
                            if (target.id === 'results' && isDailyViewActive) {
                                if (target.style.display === 'none') {
                                    console.log('🚫 BLOCKED attempt to hide results container!');
                                    target.style.setProperty('display', 'block', 'important');
                                    target.style.setProperty('visibility', 'visible', 'important');
                                }
                            }
                        }
                    });
                });
                
                mutationObserver.observe(results, {
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
                
                console.log('🛡️ MutationObserver installed to protect results container');
            }
            
            dailyViewProtectionInterval = setInterval(() => {
                if (isDailyViewActive) {
                    const dailySection = document.getElementById('dailyAnalysisSection');
                    const results = document.getElementById('results');
                    
                    // Check if daily section is hidden
                    if (dailySection && dailySection.style.display !== 'block') {
                        console.log('🛡️ Daily view protection: Restoring daily section visibility');
                        dailySection.style.display = 'block';
                    }
                    
                    // Check if results container is hidden - AGGRESSIVE FIX
                    if (results && (results.style.display === 'none' || results.classList.contains('hidden'))) {
                        console.log('🛡️ Daily view protection: AGGRESSIVELY restoring results container');
                        results.style.setProperty('display', 'block', 'important');
                        results.style.setProperty('visibility', 'visible', 'important');
                        results.style.setProperty('opacity', '1', 'important');
                        results.classList.remove('hidden');
                        
                        // Nuclear option: Remove any inline style that might be hiding it
                        results.removeAttribute('style');
                        results.style.setProperty('display', 'block', 'important');
                        results.style.setProperty('visibility', 'visible', 'important');
                    }
                    
                    // Ensure overall sections stay hidden
                    const elementsToKeepHidden = [
                        { element: document.getElementById('metricsGrid')?.parentNode, name: 'metrics grid parent' },
                        { element: document.getElementById('strategySection'), name: 'strategy section' },
                        { element: document.getElementById('chartsSection'), name: 'charts section' },
                        { element: document.getElementById('dailyAnalysisBtn'), name: 'daily analysis button' }
                    ];
                    
                    elementsToKeepHidden.forEach(({ element, name }) => {
                        if (element && element.style.display !== 'none') {
                            console.log(`🛡️ Daily view protection: Hiding ${name}`);
                            element.style.display = 'none';
                        }
                    });
                }
            }, 500); // Check every 500ms
            
            console.log('🛡️ Started daily view protection monitoring');
        }
        
        function stopDailyViewProtection() {
            if (dailyViewProtectionInterval) {
                clearInterval(dailyViewProtectionInterval);
                dailyViewProtectionInterval = null;
                console.log('🛡️ Stopped daily view protection monitoring');
            }
            
            if (mutationObserver) {
                mutationObserver.disconnect();
                mutationObserver = null;
                console.log('🛡️ Disconnected MutationObserver');
            }
        }
        
        function forceDailyViewVisibility() {
            console.log('🔧 Force daily view visibility check...');
            
            const results = document.getElementById('results');
            const dailySection = document.getElementById('dailyAnalysisSection');
            
            if (!results || !dailySection) {
                console.error('❌ Missing required elements for daily view');
                return;
            }
            
            // Force results container to be visible with !important styles
            results.style.setProperty('display', 'block', 'important');
            results.style.setProperty('visibility', 'visible', 'important');
            results.style.setProperty('opacity', '1', 'important');
            results.classList.remove('hidden');
            
            // Force daily section to be visible with !important styles
            dailySection.style.setProperty('display', 'block', 'important');
            dailySection.style.setProperty('visibility', 'visible', 'important');
            dailySection.style.setProperty('opacity', '1', 'important');
            dailySection.style.setProperty('position', 'relative', 'important');
            dailySection.style.setProperty('z-index', '1', 'important');
            
            // Force hide overall sections
            const elementsToHide = [
                document.getElementById('metricsGrid')?.parentNode,
                document.getElementById('strategySection'),
                document.getElementById('chartsSection'),
                document.getElementById('dailyAnalysisBtn')
            ];
            
            elementsToHide.forEach((element, index) => {
                if (element) {
                    element.style.setProperty('display', 'none', 'important');
                    element.style.setProperty('visibility', 'hidden', 'important');
                }
            });
            
            // Try alternative visibility approaches
            dailySection.style.setProperty('max-height', 'none', 'important');
            dailySection.style.setProperty('overflow', 'visible', 'important');
            dailySection.style.setProperty('height', 'auto', 'important');
            dailySection.style.setProperty('width', '100%', 'important');
            
            // Force scroll to daily section
            setTimeout(() => {
                dailySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 50);
            
            console.log('🔧 Forced daily view visibility settings applied');
            
            // Check if it worked
            setTimeout(() => {
                const isVisible = dailySection.offsetHeight > 0 && dailySection.offsetWidth > 0;
                console.log('🔧 Daily section now visible:', isVisible);
                console.log('🔧 Daily section dimensions:', dailySection.offsetWidth, 'x', dailySection.offsetHeight);
                
                if (!isVisible) {
                    console.error('❌ Daily section still not visible after force, checking CSS...');
                    const computedStyle = window.getComputedStyle(dailySection);
                    console.log('🔧 Computed display:', computedStyle.display);
                    console.log('🔧 Computed visibility:', computedStyle.visibility);
                    console.log('🔧 Computed opacity:', computedStyle.opacity);
                    console.log('🔧 Computed position:', computedStyle.position);
                    console.log('🔧 Computed overflow:', computedStyle.overflow);
                    console.log('🔧 Computed height:', computedStyle.height);
                    console.log('🔧 Computed width:', computedStyle.width);
                    console.log('🔧 Computed margin:', computedStyle.margin);
                    console.log('🔧 Computed padding:', computedStyle.padding);
                    
                    // Check parent container
                    const results = document.getElementById('results');
                    const resultsComputed = window.getComputedStyle(results);
                    console.log('🔧 Results computed display:', resultsComputed.display);
                    console.log('🔧 Results computed visibility:', resultsComputed.visibility);
                    console.log('🔧 Results computed opacity:', resultsComputed.opacity);
                    console.log('🔧 Results offsetHeight:', results.offsetHeight);
                }
            }, 100);
        }
    </script>
</body>
</html>
