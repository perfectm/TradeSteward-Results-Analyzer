<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeSteward Results Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }
        
        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            background-color: #f8f9ff;
            border-color: #764ba2;
        }
        
        .upload-area.dragover {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .upload-icon {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .upload-text h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.5rem;
        }
        
        .upload-text p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .results h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 2rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-positive {
            color: #4caf50;
        }
        
        .metric-negative {
            color: #f44336;
        }
        
        .charts-section {
            margin-top: 30px;
        }
        
        .chart-container {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .chart-container img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .strategy-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .strategy-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .strategy-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .strategy-table th,
        .strategy-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .strategy-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        
        .strategy-table tr:hover {
            background-color: #f5f5f5;
        }
        
        .info-section {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 5px solid #2196f3;
        }
        
        .info-section h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }
        
        .info-section ul {
            color: #333;
            margin-left: 20px;
        }
        
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f44336;
            margin-top: 20px;
        }

        .nav-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .nav-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            margin: 0 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Authentication Styles */
        .auth-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .auth-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .auth-form {
            margin-top: 20px;
        }
        
        .auth-form h3 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        
        .auth-form input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        
        .auth-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
        }
        
        .auth-button {
            width: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: transform 0.2s ease;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
        }
        
        .user-section {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logout-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .logout-button:hover {
            background: #c82333;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 TradeSteward Results Analyzer</h1>
            <p>Advanced analysis tool for options trading performance</p>
        </div>
        
        <div class="info-section">
            <h4>📊 What This Tool Analyzes:</h4>
            <ul>
                <li><strong>Strategy Performance:</strong> P&L by strategy type (Ratio Condors, etc.)</li>
                <li><strong>Risk Metrics:</strong> Win rate, profit factor, maximum drawdown, Sharpe ratio</li>
                <li><strong>Market Conditions:</strong> VIX correlation and market environment analysis</li>
                <li><strong>Time Analysis:</strong> Daily, monthly performance tracking</li>
                <li><strong>Commission Impact:</strong> Gross vs net P&L analysis</li>
                <li><strong>🔄 Persistent Data:</strong> Upload multiple CSV files - new trades are added, duplicates are skipped</li>
            </ul>
        </div>
        
        <!-- Authentication Section -->
        <div class="auth-section" id="authSection">
            <div style="text-align: center; margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h4 style="color: #495057; margin-bottom: 10px;">🔐 Authentication Required</h4>
                <p style="color: #6c757d; margin: 0;">Please login or register to access your trading analysis dashboard with commission tracking, strategy breakdowns, and comprehensive performance metrics.</p>
            </div>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showLogin()">Login</button>
                <button class="auth-tab" onclick="showRegister()">Register</button>
            </div>
            
            <div class="auth-form" id="loginForm">
                <h3>Login to Your Account</h3>
                <form onsubmit="handleLogin(event)">
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="password" name="password" placeholder="Password" required>
                    <button type="submit" class="auth-button">Login</button>
                </form>
            </div>
            
            <div class="auth-form hidden" id="registerForm">
                <h3>Create New Account</h3>
                <form onsubmit="handleRegister(event)">
                    <input type="text" name="username" placeholder="Username" required>
                    <input type="email" name="email" placeholder="Email" required>
                    <input type="password" name="password" placeholder="Password (min 6 characters)" required minlength="6">
                    <button type="submit" class="auth-button">Register</button>
                </form>
            </div>
        </div>

        <!-- User Info Section -->
        <div class="user-section hidden" id="userSection">
            <div class="user-info">
                <span id="userWelcome">Welcome, <strong id="username"></strong>!</span>
                <button class="logout-button" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="nav-section hidden" id="navSection">
            <h4 style="margin-bottom: 15px; color: #333;">📊 Quick Actions</h4>
            <button class="nav-button" id="viewDatabaseBtn" onclick="loadDatabaseAnalysis()">
                📈 View Complete Trading Analysis
            </button>
            <button class="nav-button" onclick="showUploadSection()" style="background: linear-gradient(45deg, #28a745, #20c997);">
                📁 Upload New Data
            </button>
            <button class="nav-button" onclick="confirmDeleteAllTrades()" style="background: linear-gradient(45deg, #dc3545, #c82333); margin-top: 10px;">
                🗑️ Delete All Trades
            </button>
        </div>
        
        <div class="upload-section hidden" id="uploadSection">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📈</div>
                <div class="upload-text">
                    <h3>Upload TradeSteward CSV File</h3>
                    <p>Drop your TradeSteward performance log CSV file here or click to browse</p>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Choose File
                    </button>
                </div>
                <input type="file" id="fileInput" class="file-input" accept=".csv" />
            </div>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Analyzing your trading data...</p>
            </div>
        </div>
        
        <div class="results hidden" id="results">
            <h2>📊 Cumulative Trading Analysis</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                <em>Showing comprehensive analysis across all uploaded trading data</em>
            </p>
            
            <!-- Strategy Filter Section -->
            <div class="strategy-filter-section" id="strategyFilterSection" style="display: none;">
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 25px; border: 2px solid #e9ecef;">
                    <h4 style="margin: 0 0 15px 0; color: #333; display: flex; align-items: center;">
                        <span style="margin-right: 10px;">🎯</span>
                        Strategy Filter
                        <span style="margin-left: auto; font-size: 12px; color: #666;" id="selectedStrategiesCount"></span>
                    </h4>
                    <p style="margin: 0 0 15px 0; color: #666; font-size: 14px;">
                        Select which strategies to include in the overall metrics and analysis:
                    </p>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                        <button onclick="selectAllStrategies()" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            Select All
                        </button>
                        <button onclick="deselectAllStrategies()" style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            Deselect All
                        </button>
                        <button onclick="applyStrategyFilter()" style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                            Apply Filter
                        </button>
                    </div>
                    <div class="strategy-checkboxes" id="strategyCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <!-- Strategy checkboxes will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <div class="metrics-grid" id="metricsGrid">
                <!-- Metrics will be populated by JavaScript -->
            </div>
            
            <div class="strategy-section">
                <h3>📈 Strategy Performance Breakdown <span style="font-size: 0.8em; color: #666; font-weight: normal;">(Cumulative Data)</span></h3>
                <table class="strategy-table" id="strategyTable">
                    <thead>
                        <tr>
                            <th>Strategy</th>
                            <th>Total P&L</th>
                            <th>Total Commissions</th>
                            <th>Avg P&L</th>
                            <th>Avg Commission</th>
                            <th>Trade Count</th>
                            <th>Avg %</th>
                        </tr>
                    </thead>
                    <tbody id="strategyTableBody">
                        <!-- Strategy data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="charts-section" id="chartsSection">
                <!-- Charts will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="error" id="error" style="display: none;">
            <!-- Error messages will be shown here -->
        </div>
    </div>

    <script>
        // Authentication state
        let authToken = localStorage.getItem('authToken');
        let currentUser = null;
        
        // DOM elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        const error = document.getElementById('error');
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            if (authToken) {
                validateToken();
            } else {
                showAuthSection();
            }
        });
        
        // Authentication functions
        function showLogin() {
            document.querySelector('.auth-tab.active').classList.remove('active');
            document.querySelector('.auth-tab').classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }
        
        function showRegister() {
            document.querySelector('.auth-tab.active').classList.remove('active');
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }
        
        function showAuthSection() {
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('userSection').classList.add('hidden');
            document.getElementById('navSection').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
        }
        
        function showMainApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('userSection').classList.remove('hidden');
            document.getElementById('navSection').classList.remove('hidden');
            document.getElementById('uploadSection').classList.remove('hidden');
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = { user_id: data.user_id, username: data.username };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('username').textContent = data.username;
                    showMainApp();
                    hideError();
                } else {
                    showError(data.detail || 'Login failed');
                }
            } catch (err) {
                showError('Network error during login');
            }
        }
        
        async function handleRegister(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            
            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = { user_id: data.user_id, username: data.username };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('username').textContent = data.username;
                    showMainApp();
                    hideError();
                } else {
                    showError(data.detail || 'Registration failed');
                }
            } catch (err) {
                showError('Network error during registration');
            }
        }
        
        async function validateToken() {
            try {
                const response = await fetch('/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    document.getElementById('username').textContent = data.username;
                    showMainApp();
                } else {
                    logout();
                }
            } catch (err) {
                logout();
            }
        }
        
        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showAuthSection();
            hideError();
        }
        
        // Update API calls to include authorization header
        function getAuthHeaders() {
            return {
                'Authorization': `Bearer ${authToken}`
            };
        }
        
        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        async function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                showError('Please upload a CSV file.');
                return;
            }
            
            hideError();
            showLoading();
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Upload response:', data); // Debug log
                    displayResults(data);
                } else {
                    showError(`Error: ${data.detail || 'Unknown error occurred'}`);
                }
            } catch (err) {
                showError(`Network error: ${err.message}`);
            } finally {
                hideLoading();
            }
        }
        
        function displayResults(data, isDatabaseView = false) {
            console.log('🎨 displayResults called with isDatabaseView:', isDatabaseView);
            console.log('📊 Data object keys:', Object.keys(data));
            console.log('📊 Full data:', data);
            
            const metrics = data.metrics;
            const plots = data.plots;
            
            console.log('📈 Metrics object:', metrics);
            console.log('🎭 Plots array:', plots);
            
            if (!metrics) {
                console.error('❌ No metrics data in response');
                showError('No metrics data received from server');
                return;
            }
            
            console.log('💰 Commission metrics check:', {
                total_commissions: metrics.total_commissions,
                avg_commission_per_trade: metrics.avg_commission_per_trade,
                commission_percentage: metrics.commission_percentage
            });
            
            // Store current analysis data for filtering
            currentAnalysisData = data;
            
            // Populate strategy filter if this is the initial load
            if (isDatabaseView && metrics.strategy_performance) {
                const strategies = Object.keys(metrics.strategy_performance);
                console.log('🎯 Populating strategy filter with:', strategies);
                populateStrategyFilter(strategies);
            }
            
            // Populate account filter for commission analysis
            console.log('🔍 Checking for account data...');
            console.log('data.available_accounts:', data.available_accounts);
            console.log('available_accounts exists:', 'available_accounts' in data);
            console.log('available_accounts length:', data.available_accounts ? data.available_accounts.length : 'undefined');
            
            if (data.available_accounts && data.available_accounts.length > 0) {
                console.log('✅ Calling populateAccountFilter with:', data.available_accounts);
                populateAccountFilter(data.available_accounts);
            } else {
                console.log('❌ Account filter conditions not met');
                console.log('  - available_accounts exists:', !!data.available_accounts);
                console.log('  - available_accounts length > 0:', data.available_accounts ? data.available_accounts.length > 0 : false);
            }
            
            // Remove any existing merge info
            const existingMergeInfo = document.querySelector('.merge-info');
            if (existingMergeInfo) {
                existingMergeInfo.remove();
            }
            
            // Show merge statistics if available
            if (data.new_trades !== undefined || data.updated_trades !== undefined || data.duplicate_trades !== undefined) {
                const mergeInfo = document.createElement('div');
                mergeInfo.className = 'info-section merge-info';
                
                let uploadMessage = '';
                if (isDatabaseView) {
                    uploadMessage = `📊 Displaying complete analysis of all trading data in your database`;
                } else if (data.new_trades > 0) {
                    uploadMessage = `✅ Successfully added ${data.new_trades} new trade${data.new_trades === 1 ? '' : 's'} to your database!`;
                } else if (data.updated_trades > 0) {
                    uploadMessage = `🔄 Updated ${data.updated_trades} existing trade${data.updated_trades === 1 ? '' : 's'} with latest data.`;
                } else {
                    uploadMessage = `ℹ️ No new trades found in this upload.`;
                }
                
                let cardsHtml = '';
                if (!isDatabaseView) {
                    cardsHtml = `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-top: 15px;">
                            <div style="text-align: center; padding: 10px; background: #e8f5e8; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #27ae60;">${data.new_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">New</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #fff3cd; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #f39c12;">${data.updated_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">Updated</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #f8d7da; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;">${data.duplicate_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">Skipped</div>
                            </div>
                            <div style="text-align: center; padding: 10px; background: #d1ecf1; border-radius: 8px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #17a2b8;">${data.total_trades || 0}</div>
                                <div style="font-size: 0.9em; color: #666;">Total in DB</div>
                            </div>
                        </div>`;
                } else {
                    cardsHtml = `
                        <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; color: white; margin-top: 15px;">
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;">${data.total_trades || 0}</div>
                            <div style="font-size: 1.2em;">Total Trades in Database</div>
                            <div style="font-size: 1em; margin-top: 5px; opacity: 0.9;">Date Range: ${data.date_range || 'N/A'}</div>
                        </div>`;
                }
                
                mergeInfo.innerHTML = `
                    <h4>${isDatabaseView ? '📊 Database Analysis:' : `📊 Upload Results for "${data.filename || 'file'}":`}</h4>
                    <p style="font-size: 1.1em; color: #2c3e50; margin-bottom: 10px;">${uploadMessage}</p>
                    ${cardsHtml}
                    <p style="margin-top: 15px; font-style: italic; color: #666; text-align: center;">
                        📈 Analysis below includes ALL trades from your complete trading history
                    </p>
                `;
                
                // Insert before the metrics grid
                const metricsGrid = document.getElementById('metricsGrid');
                metricsGrid.parentNode.insertBefore(mergeInfo, metricsGrid);
            }
            
            // Add header for metrics section
            const metricsContainer = document.getElementById('metricsGrid').parentNode;
            let existingHeader = metricsContainer.querySelector('.metrics-header');
            if (existingHeader) {
                existingHeader.remove();
            }
            
            const metricsHeader = document.createElement('h3');
            metricsHeader.className = 'metrics-header';
            metricsHeader.style.cssText = 'text-align: center; color: #333; margin: 20px 0 15px 0; border-bottom: 2px solid #667eea; padding-bottom: 10px;';
            metricsHeader.innerHTML = '📊 Overall Performance Metrics <span style="font-size: 0.8em; color: #666; font-weight: normal;">(All Trading Data)</span>';
            
            const metricsGrid = document.getElementById('metricsGrid');
            metricsGrid.parentNode.insertBefore(metricsHeader, metricsGrid);
            
            // Display key metrics
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-value ${metrics.total_pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.total_pnl.toLocaleString()}
                    </div>
                    <div class="metric-label">Total Net P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.total_gross_pnl >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.total_gross_pnl.toLocaleString()}
                    </div>
                    <div class="metric-label">Total Gross P&L</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        $${(metrics.total_commissions || 0).toLocaleString()}
                    </div>
                    <div class="metric-label">Total Commissions</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value">${metrics.total_trades}</div>
                    <div class="metric-label">Total Trades</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        $${(metrics.avg_commission_per_trade || 0).toFixed(2)}
                    </div>
                    <div class="metric-label">Avg Commission/Trade</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        ${(metrics.commission_percentage || 0).toFixed(1)}%
                    </div>
                    <div class="metric-label">Commission %</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.win_rate >= 50 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.win_rate}%
                    </div>
                    <div class="metric-label">Win Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.profit_factor >= 1 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.profit_factor === Infinity ? '∞' : metrics.profit_factor}
                    </div>
                    <div class="metric-label">Profit Factor</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.max_drawdown >= 0 ? 'metric-positive' : 'metric-negative'}">
                        $${metrics.max_drawdown.toLocaleString()}
                    </div>
                    <div class="metric-label">Max Drawdown</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${metrics.sharpe_ratio >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.sharpe_ratio}
                    </div>
                    <div class="metric-label">Sharpe Ratio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${(metrics.mar_ratio || 0) >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${(metrics.mar_ratio || 0).toFixed(2)}
                    </div>
                    <div class="metric-label">MAR Ratio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${(metrics.sortino_ratio || 0) >= 0 ? 'metric-positive' : 'metric-negative'}">
                        ${metrics.sortino_ratio === Infinity ? '∞' : (metrics.sortino_ratio || 0).toFixed(2)}
                    </div>
                    <div class="metric-label">Sortino Ratio</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value ${(metrics.ulcer_index || 0) <= 10 ? 'metric-positive' : 'metric-negative'}">
                        ${(metrics.ulcer_index || 0).toFixed(2)}%
                    </div>
                    <div class="metric-label">Ulcer Index</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-positive">
                        $${metrics.avg_winner.toLocaleString()}
                    </div>
                    <div class="metric-label">Avg Winner</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value metric-negative">
                        $${metrics.avg_loser.toLocaleString()}
                    </div>
                    <div class="metric-label">Avg Loser</div>
                </div>
            `;
            
            // Display strategy performance table
            const strategyTableBody = document.getElementById('strategyTableBody');
            let strategyRows = '';
            
            const strategyPerf = metrics.strategy_performance;
            for (const strategy in strategyPerf) {
                const strategyData = strategyPerf[strategy];
                const totalPnL = strategyData.total_pnl;
                const totalCommissions = strategyData.total_commissions || 0;
                const avgPnL = strategyData.avg_pnl;
                const avgCommission = strategyData.avg_commission || 0;
                const count = strategyData.trade_count;
                const avgPercent = strategyData.avg_percentage || 0;
                
                strategyRows += `
                    <tr>
                        <td>${strategy}</td>
                        <td class="${totalPnL >= 0 ? 'metric-positive' : 'metric-negative'}">
                            $${totalPnL.toLocaleString()}
                        </td>
                        <td class="metric-negative">
                            $${totalCommissions.toLocaleString()}
                        </td>
                        <td class="${avgPnL >= 0 ? 'metric-positive' : 'metric-negative'}">
                            $${avgPnL.toFixed(2)}
                        </td>
                        <td class="metric-negative">
                            $${avgCommission.toFixed(2)}
                        </td>
                        <td>${count}</td>
                        <td class="${avgPercent >= 0 ? 'metric-positive' : 'metric-negative'}">
                            ${avgPercent.toFixed(1)}%
                        </td>
                    </tr>
                `;
            }
            strategyTableBody.innerHTML = strategyRows;
            
            // Display charts
            const chartsSection = document.getElementById('chartsSection');
            let chartsHtml = '<h3 style="text-align: center; color: #333; margin-bottom: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px;">📊 Visual Analysis <span style="font-size: 0.8em; color: #666; font-weight: normal;">(All Trading Data)</span></h3>';
            
            plots.forEach((plotFile, index) => {
                const titles = [
                    'Cumulative P&L Performance',
                    'Strategy Analysis', 
                    'Risk & Performance Metrics',
                    'Commission Analysis'
                ];
                
                // Special handling for Commission Analysis chart
                if (index === 3) {
                    chartsHtml += `
                        <div class="chart-container">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">${titles[index]}</h3>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="accountFilter" style="font-size: 14px; color: #666;">Filter by Account:</label>
                                    <select id="accountFilter" onchange="applyAccountFilter()" style="padding: 5px 10px; border: 1px solid #ddd; border-radius: 5px; background: white; font-size: 14px;">
                                        <option value="all">All Accounts</option>
                                    </select>
                                </div>
                            </div>
                            <div id="commissionChartContainer">
                                <img src="/uploads/${plotFile}" alt="${titles[index]}" />
                            </div>
                        </div>
                    `;
                } else {
                    chartsHtml += `
                        <div class="chart-container">
                            <h3>${titles[index] || `Chart ${index + 1}`}</h3>
                            <img src="/uploads/${plotFile}" alt="${titles[index] || `Chart ${index + 1}`}" />
                        </div>
                    `;
                }
            });
            
            chartsSection.innerHTML = chartsHtml;
            
            // Show results
            console.log('🎯 About to show results section');
            results.classList.remove('hidden');
            results.style.display = 'block';
            console.log('✅ Removed hidden class and set display to block');
            results.scrollIntoView({ behavior: 'smooth' });
            console.log('📜 Scrolled to results section');
        }
        
        function showLoading() {
            loading.style.display = 'block';
            results.style.display = 'none';
        }
        
        function hideLoading() {
            loading.style.display = 'none';
        }
        
        function showError(message) {
            error.innerHTML = `<strong>Error:</strong> ${message}`;
            error.style.display = 'block';
            results.style.display = 'none';
        }
        
        function hideError() {
            error.style.display = 'none';
        }

        async function loadDatabaseAnalysis() {
            console.log('🚀 loadDatabaseAnalysis called');
            hideError();
            showLoading();
            
            const button = document.getElementById('viewDatabaseBtn');
            button.disabled = true;
            button.textContent = '📊 Loading Analysis...';
            
            try {
                console.log('📡 Making request to /database-analysis');
                const response = await fetch('/database-analysis', {
                    headers: getAuthHeaders()
                });
                
                console.log('📨 Response received:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('📊 Parsed response data:', data);
                
                if (data.success) {
                    console.log('✅ Success response - calling displayResults');
                    console.log('📈 Metrics preview:', data.metrics ? Object.keys(data.metrics).slice(0, 5) : 'NO METRICS');
                    
                    // Modify data to show it's from database
                    data.filename = 'Complete Database';
                    data.new_trades = 0;
                    data.updated_trades = 0;
                    data.duplicate_trades = 0;
                    
                    console.log('🎯 About to call displayResults with:', data);
                    displayResults(data, true); // Pass true to indicate this is database view
                    console.log('✅ displayResults completed');
                } else {
                    console.log('❌ API returned success=false');
                    showError(`Error: ${data.detail || 'Unknown error occurred'}`);
                }
            } catch (err) {
                console.error('❌ Error in loadDatabaseAnalysis:', err);
                if (err.message.includes('404')) {
                    showError('No trading data found in database. Please upload a CSV file first.');
                } else {
                    showError(`Network error: ${err.message}`);
                }
            } finally {
                console.log('🏁 loadDatabaseAnalysis finally block');
                hideLoading();
                button.disabled = false;
                button.textContent = '📈 View Complete Trading Analysis';
            }
        }

        function showUploadSection() {
            const uploadSection = document.getElementById('uploadSection');
            const results = document.getElementById('results');
            
            uploadSection.style.display = 'block';
            results.style.display = 'none';
            
            // Scroll to upload section
            uploadSection.scrollIntoView({ behavior: 'smooth' });
        }

        // Strategy filtering functionality
        let currentAnalysisData = null;
        let selectedStrategies = new Set();

        function populateStrategyFilter(strategies) {
            const checkboxContainer = document.getElementById('strategyCheckboxes');
            const filterSection = document.getElementById('strategyFilterSection');
            
            if (!strategies || strategies.length === 0) {
                filterSection.style.display = 'none';
                return;
            }
            
            // Clear existing checkboxes
            checkboxContainer.innerHTML = '';
            
            // Initialize all strategies as selected
            selectedStrategies.clear();
            strategies.forEach(strategy => selectedStrategies.add(strategy));
            
            // Create checkboxes for each strategy
            strategies.forEach(strategy => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'display: flex; align-items: center; padding: 8px; background: white; border-radius: 5px; border: 1px solid #ddd;';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `strategy_${strategy.replace(/\s+/g, '_')}`;
                checkbox.checked = true;
                checkbox.style.marginRight = '8px';
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedStrategies.add(strategy);
                    } else {
                        selectedStrategies.delete(strategy);
                    }
                    updateSelectedCount();
                });
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = strategy;
                label.style.cssText = 'flex: 1; cursor: pointer; font-size: 14px;';
                
                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });
            
            updateSelectedCount();
            filterSection.style.display = 'block';
        }
        
        function updateSelectedCount() {
            const countElement = document.getElementById('selectedStrategiesCount');
            const total = document.querySelectorAll('#strategyCheckboxes input[type="checkbox"]').length;
            const selected = selectedStrategies.size;
            countElement.textContent = `${selected}/${total} selected`;
        }
        
        function selectAllStrategies() {
            const checkboxes = document.querySelectorAll('#strategyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
                const strategy = checkbox.nextElementSibling.textContent;
                selectedStrategies.add(strategy);
            });
            updateSelectedCount();
        }
        
        function deselectAllStrategies() {
            const checkboxes = document.querySelectorAll('#strategyCheckboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedStrategies.clear();
            updateSelectedCount();
        }
        
        async function applyStrategyFilter() {
            if (!currentAnalysisData) {
                showError('No analysis data available to filter');
                return;
            }
            
            if (selectedStrategies.size === 0) {
                showError('Please select at least one strategy');
                return;
            }
            
            // Show loading
            showLoading();
            
            try {
                const strategiesArray = Array.from(selectedStrategies);
                const response = await fetch('/database-analysis-filtered', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        strategies: strategiesArray
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Update the display with filtered data
                    data.filename = `Filtered Analysis (${strategiesArray.length} strategies)`;
                    data.new_trades = 0;
                    data.updated_trades = 0;
                    data.duplicate_trades = 0;
                    
                    displayResults(data, true);
                } else {
                    showError(`Error: ${data.detail || 'Unknown error occurred'}`);
                }
            } catch (err) {
                showError(`Network error: ${err.message}`);
            } finally {
                hideLoading();
            }
        }

        // Account filtering functionality for commission analysis
        function populateAccountFilter(accounts) {
            const accountSelect = document.getElementById('accountFilter');
            if (!accountSelect) return;
            
            // Clear existing options except "All Accounts"
            accountSelect.innerHTML = '<option value="all">All Accounts</option>';
            
            // Add account options with obfuscated display names
            accounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.account_num;  // Use real account number for filtering
                option.textContent = `Account ${account.account_display} (${account.trade_count} trades)`;  // Use obfuscated display
                accountSelect.appendChild(option);
            });
            
            console.log('🏦 Populated account filter with obfuscated accounts:', accounts.map(a => ({display: a.account_display, trades: a.trade_count})));
        }
        
        async function applyAccountFilter() {
            const accountSelect = document.getElementById('accountFilter');
            const selectedAccount = accountSelect.value;
            
            if (!currentAnalysisData) {
                showError('No analysis data available to filter');
                return;
            }
            
            console.log('🏦 Applying account filter:', selectedAccount);
            
            // Show loading on just the commission chart
            const chartContainer = document.getElementById('commissionChartContainer');
            if (chartContainer) {
                chartContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><div class="spinner" style="display: inline-block; margin-bottom: 10px;"></div><br>Loading commission analysis...</div>';
            }
            
            try {
                const response = await fetch('/commission-analysis-by-account', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account_num: selectedAccount === 'all' ? null : selectedAccount
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.commission_plot) {
                    // Update only the commission chart
                    chartContainer.innerHTML = `<img src="/uploads/${data.commission_plot}" alt="Commission Analysis" />`;
                    console.log('✅ Commission chart updated for account:', selectedAccount);
                } else {
                    throw new Error(data.detail || 'Failed to generate commission chart');
                }
            } catch (err) {
                console.error('❌ Error filtering by account:', err);
                chartContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc3545;">Error loading commission analysis. Please try again.</div>';
            }
        }

        // Delete all trades functionality
        function confirmDeleteAllTrades() {
            const userConfirm = confirm(
                '⚠️ WARNING: This will permanently delete ALL your trading data!\n\n' +
                'Are you sure you want to delete all trades? This action cannot be undone.\n\n' +
                'Click OK to proceed or Cancel to abort.'
            );
            
            if (userConfirm) {
                const doubleConfirm = confirm(
                    '🚨 FINAL CONFIRMATION 🚨\n\n' +
                    'This will PERMANENTLY DELETE all your trading data.\n' +
                    'You will lose all analysis history, metrics, and uploaded trades.\n\n' +
                    'Are you absolutely sure you want to continue?'
                );
                
                if (doubleConfirm) {
                    deleteAllTrades();
                }
            }
        }
        
        async function deleteAllTrades() {
            if (!currentUser) {
                showError('You must be logged in to delete trades');
                return;
            }
            
            console.log('🗑️ Starting delete all trades process...');
            
            // Show loading indicator
            const deleteButton = document.querySelector('button[onclick="confirmDeleteAllTrades()"]');
            const originalText = deleteButton.textContent;
            deleteButton.disabled = true;
            deleteButton.textContent = '🔄 Deleting...';
            deleteButton.style.background = '#6c757d';
            
            try {
                const response = await fetch('/delete-all-trades', {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('✅ All trades deleted successfully');
                    
                    // Clear the results section
                    const results = document.getElementById('results');
                    if (results) {
                        results.style.display = 'none';
                        results.classList.add('hidden');
                    }
                    
                    // Show success message
                    alert(`✅ Success!\n\nDeleted ${data.deleted_count} trades from your account.\nYou can now upload new CSV files to start fresh.`);
                    
                    // Show upload section
                    showUploadSection();
                    
                } else {
                    throw new Error(data.detail || 'Failed to delete trades');
                }
                
            } catch (err) {
                console.error('❌ Error deleting trades:', err);
                alert(`❌ Error deleting trades:\n\n${err.message}\n\nPlease try again or contact support if the problem persists.`);
            } finally {
                // Restore button
                deleteButton.disabled = false;
                deleteButton.textContent = originalText;
                deleteButton.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
            }
        }
    </script>
</body>
</html>
